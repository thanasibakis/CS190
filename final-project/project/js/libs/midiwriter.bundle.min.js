var MidiWriter=function(){"use strict";var t={VERSION:"1.7.3",HEADER_CHUNK_TYPE:[77,84,104,100],HEADER_CHUNK_LENGTH:[0,0,0,6],HEADER_CHUNK_FORMAT0:[0,0],HEADER_CHUNK_FORMAT1:[0,1],HEADER_CHUNK_DIVISION:[0,128],TRACK_CHUNK_TYPE:[77,84,114,107],META_EVENT_ID:255,META_TEXT_ID:1,META_COPYRIGHT_ID:2,META_TRACK_NAME_ID:3,META_INSTRUMENT_NAME_ID:4,META_LYRIC_ID:5,META_MARKER_ID:6,META_CUE_POINT:7,META_TEMPO_ID:81,META_SMTPE_OFFSET:84,META_TIME_SIGNATURE_ID:88,META_KEY_SIGNATURE_ID:89,META_END_OF_TRACK_ID:[47,0],CONTROLLER_CHANGE_STATUS:176,PROGRAM_CHANGE_STATUS:192,PITCH_BEND_STATUS:224};function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function a(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}var r=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/,o=[0,2,4,5,7,9,11];function c(t,e,n){if("string"!=typeof t)return null;var i=r.exec(t);if(!i||!e&&i[4])return null;var a={letter:i[1].toUpperCase(),acc:i[2].replace(/x/g,"##")};a.pc=a.letter+a.acc,a.step=(a.letter.charCodeAt(0)+3)%7,a.alt="b"===a.acc[0]?-a.acc.length:a.acc.length;var c=o[a.step]+a.alt;return a.chroma=c<0?12+c:c%12,i[3]&&(a.oct=+i[3],a.midi=c+12*(a.oct+1),a.freq=function(t,e){return Math.pow(2,(t-69)/12)*(e||440)}(a.midi,n)),e&&(a.tonicOf=i[4]),a}function s(t){return Array.isArray(t)&&2===t.length?7*t[0]+12*t[1]+12:function(t){if(("number"==typeof t||function(t){return"string"==typeof t}(t))&&t>=0&&t<128)return+t;var e=c(t);return e&&function(t){return void 0!==t}(e.midi)?e.midi:null}(t)}var u=function(){function e(){n(this,e)}return a(e,null,[{key:"version",value:function(){return t.VERSION}},{key:"stringToBytes",value:function(t){return t.split("").map((function(t){return t.charCodeAt()}))}},{key:"isNumeric",value:function(t){return!isNaN(parseFloat(t))&&isFinite(t)}},{key:"getPitch",value:function(t){return s(t)}},{key:"numberToVariableLength",value:function(t){for(var e=127&t;t>>=7;)e<<=8,e|=127&t|128;for(var n=[];n.push(255&e),128&e;)e>>=8;return n}},{key:"stringByteCount",value:function(t){return encodeURI(t).split(/%..|./).length-1}},{key:"numberFromBytes",value:function(t){var e,n="";return t.forEach((function(t){1==(e=t.toString(16)).length&&(e="0"+e),n+=e})),parseInt(n,16)}},{key:"numberToBytes",value:function(t,e){e=e||1;var n=t.toString(16);1&n.length&&(n="0"+n);var i=n.match(/.{2}/g);if((i=i.map((function(t){return parseInt(t,16)}))).length<e)for(;e-i.length>0;)i.unshift(0);return i}},{key:"toArray",value:function(t){return Array.isArray(t)?t:[t]}},{key:"convertVelocity",value:function(t){return t=t>100?100:t,Math.round(t/100*127)}},{key:"getTickDuration",value:function(n){if(Array.isArray(n))return n.map((function(t){return e.getTickDuration(t)})).reduce((function(t,e){return t+e}),0);if("t"===(n=n.toString()).toLowerCase().charAt(0))return parseInt(n.substring(1));var i=e.numberFromBytes(t.HEADER_CHUNK_DIVISION);return Math.round(i*e.getDurationMultiplier(n))}},{key:"getDurationMultiplier",value:function(t){switch(t){case"0":return 0;case"1":return 4;case"2":return 2;case"d2":return 3;case"dd2":return 3.5;case"4":return 1;case"4t":return.666;case"d4":return 1.5;case"dd4":return 1.75;case"8":return.5;case"8t":return.33;case"d8":return.75;case"dd8":return.875;case"16":return.25;case"16t":return.166;case"32":return.125;case"64":return.0625}throw t+" is not a valid duration."}}]),e}(),h=function(){function t(e){n(this,t),e=Object.assign({channel:1,startTick:null,velocity:50,wait:0},e),this.type="note-on",this.channel=e.channel,this.pitch=e.pitch,this.wait=e.wait,this.velocity=e.velocity,this.startTick=e.startTick,this.midiNumber=u.getPitch(this.pitch),this.tick=null,this.delta=null,this.data=e.data}return a(t,[{key:"buildData",value:function(t){return this.data=[],this.startTick?(this.tick=this.startTick,0==t.tickPointer&&(this.delta=this.tick)):(this.delta=u.getTickDuration(this.wait),this.tick=t.tickPointer+this.delta),this.data=u.numberToVariableLength(this.delta).concat(this.getStatusByte(),this.midiNumber,u.convertVelocity(this.velocity)),this}},{key:"getStatusByte",value:function(){return 144+this.channel-1}}]),t}(),l=function(){function t(e){n(this,t),e=Object.assign({channel:1,noteOnTick:null,velocity:50},e),this.type="note-off",this.channel=e.channel,this.pitch=e.pitch,this.duration=e.duration,this.velocity=e.velocity,this.noteOnTick=e.noteOnTick,this.midiNumber=u.getPitch(this.pitch),this.tick=null,this.delta=u.getTickDuration(this.duration),this.data=e.data}return a(t,[{key:"buildData",value:function(t){return this.noteOnTick?this.tick=this.noteOnTick+u.getTickDuration(this.duration):this.tick=this.delta+t.tickPointer,this.data=u.numberToVariableLength(this.delta).concat(this.getStatusByte(),this.midiNumber,u.convertVelocity(this.velocity)),this}},{key:"getStatusByte",value:function(){return 128+this.channel-1}}]),t}(),f=function(){function e(t){n(this,e),t=Object.assign({channel:1,repeat:1,sequential:!1,startTick:null,velocity:50,wait:0},t),this.data=[],this.type="note",this.pitch=u.toArray(t.pitch),this.channel=t.channel,this.duration=t.duration,this.grace=t.grace,this.repeat=t.repeat,this.sequential=t.sequential,this.startTick=t.startTick,this.velocity=t.velocity,this.wait=t.wait,this.tickDuration=u.getTickDuration(this.duration),this.restDuration=u.getTickDuration(this.wait),this.events=[]}return a(e,[{key:"buildData",value:function(){var n=this;this.data=[];var i=this.tickDuration;this.restDuration;if(this.grace){this.grace=u.toArray(this.grace),this.grace.forEach((function(t){var a=new e({pitch:n.grace,duration:"T1"});n.data=n.data.concat(a.data),i-=1}))}if(this.sequential)for(a=0;a<this.repeat;a++)this.pitch.forEach((function(e,a){if(a>0&&0,"8t"===n.duration&&a==n.pitch.length-1){var r=u.numberFromBytes(t.HEADER_CHUNK_DIVISION);i=r-2*i}var o=new h({channel:n.channel,wait:a>0?0:n.wait,velocity:n.velocity,pitch:e,startTick:n.startTick}),c=new l({channel:n.channel,duration:n.duration,velocity:n.velocity,pitch:e,noteOnTick:n.startTick});n.events.push(o,c)}));else for(var a=0;a<this.repeat;a++)this.pitch.forEach((function(t,e){if(0==e)var i=new h({channel:n.channel,wait:n.wait,velocity:n.velocity,pitch:t,startTick:n.startTick});else i=new h({channel:n.channel,wait:0,velocity:n.velocity,pitch:t,startTick:n.startTick});n.events.push(i)})),this.pitch.forEach((function(t,e){if(0==e)var i=new l({channel:n.channel,duration:n.duration,velocity:n.velocity,pitch:t,noteOnTick:n.startTick});else i=new l({channel:n.channel,duration:0,velocity:n.velocity,pitch:t,noteOnTick:n.startTick});n.events.push(i)}));return this}}]),e}(),d=function e(i){n(this,e),this.type="pitch-bend";var a,r=(a=i.bend)<=0?Math.floor(16384*(a+1)/2):Math.floor(16383*(a+1)/2),o=i.channel||0,c=127&r,s=r>>7&127;this.data=u.numberToVariableLength(0).concat(t.PITCH_BEND_STATUS|o,c,s)},v=function e(i){n(this,e),this.type="controller",this.data=u.numberToVariableLength(0).concat(t.CONTROLLER_CHANGE_STATUS,i.controllerNumber,i.controllerValue)},T=function e(i){n(this,e),this.type="copyright";var a=u.stringToBytes(i);this.data=u.numberToVariableLength(0).concat(t.META_EVENT_ID,t.META_COPYRIGHT_ID,u.numberToVariableLength(a.length),a)},y=function e(i){n(this,e),this.type="marker";var a=u.stringToBytes(i);this.data=u.numberToVariableLength(0).concat(t.META_EVENT_ID,t.META_CUE_POINT,u.numberToVariableLength(a.length),a)},E=function e(){n(this,e),this.type="end-track",this.data=u.numberToVariableLength(0).concat(t.META_EVENT_ID,t.META_END_OF_TRACK_ID)},p=function e(i){n(this,e),this.type="instrument-name";var a=u.stringToBytes(i);this.data=u.numberToVariableLength(0).concat(t.META_EVENT_ID,t.META_INSTRUMENT_NAME_ID,u.numberToVariableLength(a.length),a)},b=function e(i,a){n(this,e),this.type="key-signature";var r=a||0;if(i=i||0,void 0===a){var o=i.length,c=i||"C";if(i[0]===i[0].toLowerCase()&&(r=1),o>1)switch(i.charAt(o-1)){case"m":case"-":r=1,c=(c=i.charAt(0).toLowerCase()).concat(i.substring(1,o-1));break;case"M":case"+":r=0,c=(c=i.charAt(0).toUpperCase()).concat(i.substring(1,o-1))}var s=[["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"],["ab","eb","bb","f","c","g","d","a","e","b","f#","c#","g#","d#","a#"]][r].indexOf(c);i=-1===s?0:s-7}this.data=u.numberToVariableLength(0).concat(t.META_EVENT_ID,t.META_KEY_SIGNATURE_ID,[2],u.numberToBytes(i,1),u.numberToBytes(r,1))},g=function e(i){n(this,e),this.type="marker";var a=u.stringToBytes(i);this.data=u.numberToVariableLength(0).concat(t.META_EVENT_ID,t.META_LYRIC_ID,u.numberToVariableLength(a.length),a)},k=function e(i){n(this,e),this.type="marker";var a=u.stringToBytes(i);this.data=u.numberToVariableLength(0).concat(t.META_EVENT_ID,t.META_MARKER_ID,u.numberToVariableLength(a.length),a)},m=function e(i){n(this,e),this.type="tempo";var a=Math.round(6e7/i);this.data=u.numberToVariableLength(0).concat(t.META_EVENT_ID,t.META_TEMPO_ID,[3],u.numberToBytes(a,3))},_=function e(i){n(this,e),this.type="text";var a=u.stringToBytes(i);this.data=u.numberToVariableLength(0).concat(t.META_EVENT_ID,t.META_TEXT_ID,u.numberToVariableLength(a.length),a)},A=function e(i,a,r,o){n(this,e),this.type="time-signature",this.data=u.numberToVariableLength(0).concat(t.META_EVENT_ID,t.META_TIME_SIGNATURE_ID,[4],u.numberToBytes(i,1),u.numberToBytes(Math.log2(a),1),u.numberToBytes(r||24,1),u.numberToBytes(o||8,1))},w=function e(i){n(this,e),this.type="track-name";var a=u.stringToBytes(i);this.data=u.numberToVariableLength(0).concat(t.META_EVENT_ID,t.META_TRACK_NAME_ID,u.numberToVariableLength(a.length),a)},D=function(){function i(){n(this,i),this.type=t.TRACK_CHUNK_TYPE,this.data=[],this.size=[],this.events=[],this.explicitTickEvents=[],this.tickPointer=0}return a(i,[{key:"addEvent",value:function(t,n){var i=this;return u.toArray(t).forEach((function(t,a){if("note"===t.type){if("function"==typeof n){var r=n(a,t);if("object"===e(r))for(var o in r)switch(o){case"channel":t.channel=r[o];break;case"duration":t.duration=r[o];break;case"sequential":t.sequential=r[o];break;case"velocity":t.velocity=u.convertVelocity(r[o])}}null!==t.startTick?i.explicitTickEvents.push(t):t.buildData().events.forEach((function(t){return i.events.push(t)}))}else i.events.push(t)})),this}},{key:"buildData",value:function(){var t=this;return this.removeEventsByType("end-track").addEvent(new E),this.data=[],this.size=[],this.tickPointer=0,this.events.forEach((function(e,n){"note-on"===e.type||"note-off"===e.type?(t.data=t.data.concat(e.buildData(t).data),t.tickPointer=e.tick):t.data=t.data.concat(e.data)})),this.mergeExplicitTickEvents(),this.size=u.numberToBytes(this.data.length,4),this}},{key:"mergeExplicitTickEvents",value:function(){var t=this;this.explicitTickEvents.length&&(this.explicitTickEvents.sort((function(t,e){return t.startTick-e.startTick})),this.explicitTickEvents.forEach((function(e){e.buildData().events.forEach((function(e){return e.buildData(t)})),e.events.forEach((function(e){return t.mergeSingleEvent(e)}))})),this.explicitTickEvents=[],this.buildData())}},{key:"mergeTrack",value:function(t){var e=this;this.buildData(),t.buildData().events.forEach((function(t){return e.mergeSingleEvent(t)}))}},{key:"mergeSingleEvent",value:function(t){for(var e=0,n=0;n<this.events.length&&!(this.events[n].tick>t.tick);n++)e=n;var i=e+1;t.delta=t.tick-this.events[e].tick,this.events.splice(i,0,t);for(n=i+1;n<this.events.length;n++)this.events[n].delta=this.events[n].tick-this.events[n-1].tick}},{key:"removeEventsByType",value:function(t){var e=this;return this.events.forEach((function(n,i){n.type===t&&e.events.splice(i,1)})),this}},{key:"setTempo",value:function(t){return this.addEvent(new m(t))}},{key:"setTimeSignature",value:function(t,e,n,i){return this.addEvent(new A(t,e,n,i))}},{key:"setKeySignature",value:function(t,e){return this.addEvent(new b(t,e))}},{key:"addText",value:function(t){return this.addEvent(new _(t))}},{key:"addCopyright",value:function(t){return this.addEvent(new T(t))}},{key:"addTrackName",value:function(t){return this.addEvent(new w(t))}},{key:"addInstrumentName",value:function(t){return this.addEvent(new p(t))}},{key:"addMarker",value:function(t){return this.addEvent(new k(t))}},{key:"addCuePoint",value:function(t){return this.addEvent(new y(t))}},{key:"addLyric",value:function(t){return this.addEvent(new g(t))}},{key:"polyModeOn",value:function(){var t=new h({data:[0,176,126,0]});return this.addEvent(t)}},{key:"setPitchBend",value:function(t){return this.addEvent(new d({bend:t}))}},{key:"controllerChange",value:function(t,e){return this.addEvent(new v({controllerNumber:t,controllerValue:e}))}}]),i}(),M=function(){function t(){n(this,t)}return a(t,[{key:"trackFromVoice",value:function(t){var e,n=this,i=new D,a=[];return t.tickables.forEach((function(t){if(a=[],"n"===t.noteType)t.keys.forEach((function(t){a.push(n.convertPitch(t))}));else if("r"===t.noteType)return void(e=n.convertDuration(t));i.addEvent(new f({pitch:a,duration:n.convertDuration(t),wait:e})),e=0})),i}},{key:"convertPitch",value:function(t){return t.replace("/","")}},{key:"convertDuration",value:function(t){switch(t.duration){case"w":return"1";case"h":return t.isDotted()?"d2":"2";case"q":return t.isDotted()?"d4":"4";case"8":return t.isDotted()?"d8":"8"}return t.duration}}]),t}(),N="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var I=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t,e){!function(){function e(t,e,n){var i=new XMLHttpRequest;i.open("GET",t),i.responseType="blob",i.onload=function(){r(i.response,e,n)},i.onerror=function(){console.error("could not download file")},i.send()}function n(t){var e=new XMLHttpRequest;e.open("HEAD",t,!1);try{e.send()}catch(t){}return 200<=e.status&&299>=e.status}function i(t){try{t.dispatchEvent(new MouseEvent("click"))}catch(n){var e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(e)}}var a="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof N&&N.global===N?N:void 0,r=a.saveAs||("object"!=typeof window||window!==a?function(){}:"download"in HTMLAnchorElement.prototype?function(t,r,o){var c=a.URL||a.webkitURL,s=document.createElement("a");r=r||t.name||"download",s.download=r,s.rel="noopener","string"==typeof t?(s.href=t,s.origin===location.origin?i(s):n(s.href)?e(t,r,o):i(s,s.target="_blank")):(s.href=c.createObjectURL(t),setTimeout((function(){c.revokeObjectURL(s.href)}),4e4),setTimeout((function(){i(s)}),0))}:"msSaveOrOpenBlob"in navigator?function(t,a,r){if(a=a||t.name||"download","string"!=typeof t)navigator.msSaveOrOpenBlob(function(t,e){return void 0===e?e={autoBom:!1}:"object"!=typeof e&&(console.warn("Deprecated: Expected third argument to be a object"),e={autoBom:!e}),e.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob(["\ufeff",t],{type:t.type}):t}(t,r),a);else if(n(t))e(t,a,r);else{var o=document.createElement("a");o.href=t,o.target="_blank",setTimeout((function(){i(o)}))}}:function(t,n,i,r){if((r=r||open("","_blank"))&&(r.document.title=r.document.body.innerText="downloading..."),"string"==typeof t)return e(t,n,i);var o="application/octet-stream"===t.type,c=/constructor/i.test(a.HTMLElement)||a.safari,s=/CriOS\/[\d]+/.test(navigator.userAgent);if((s||o&&c)&&"object"==typeof FileReader){var u=new FileReader;u.onloadend=function(){var t=u.result;t=s?t:t.replace(/^data:[^;]*;/,"data:attachment/file;"),r?r.location.href=t:location=t,r=null},u.readAsDataURL(t)}else{var h=a.URL||a.webkitURL,l=h.createObjectURL(t);r?r.location=l:location.href=l,r=null,setTimeout((function(){h.revokeObjectURL(l)}),4e4)}});a.saveAs=r.saveAs=r,t.exports=r}()})),R=function e(i){n(this,e),this.type=t.HEADER_CHUNK_TYPE;var a=i>1?t.HEADER_CHUNK_FORMAT1:t.HEADER_CHUNK_FORMAT0;this.data=a.concat(u.numberToBytes(i,2),t.HEADER_CHUNK_DIVISION),this.size=[0,0,0,this.data.length]},C=function(){function t(e){var i=this;n(this,t),e=u.toArray(e),this.data=[],this.data.push(new R(e.length)),e.forEach((function(t,e){i.data.push(t.buildData())}))}return a(t,[{key:"buildFile",value:function(){var t=[];return this.data.forEach((function(e){return t=t.concat(e.type,e.size,e.data)})),new Uint8Array(t)}},{key:"base64",value:function(){return"function"==typeof btoa?btoa(String.fromCharCode.apply(null,this.buildFile())):Buffer.from(this.buildFile()).toString("base64")}},{key:"dataUri",value:function(){return"data:audio/midi;base64,"+this.base64()}},{key:"stdout",value:function(){return process.stdout.write(new Buffer(this.buildFile()))}},{key:"saveMIDI",value:function(t){var e=I,n=new Blob([this.buildFile()],{type:"audio/mid"});e.saveAs(n,t+".mid")}}]),t}();return{Constants:t,NoteOnEvent:h,NoteOffEvent:l,NoteEvent:f,PitchBendEvent:d,ProgramChangeEvent:function e(i){n(this,e),this.type="program",this.data=u.numberToVariableLength(0).concat(t.PROGRAM_CHANGE_STATUS,i.instrument)},Track:D,Utils:u,VexFlow:M,Writer:C}}();
